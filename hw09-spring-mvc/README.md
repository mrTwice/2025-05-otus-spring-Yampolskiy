
# Домашнее задание
**CRUD приложение с Web UI и хранением данных в БД**

## Цель:
Цель: разрабатывать полноценные классические Web-приложения

## Результат:
Web-приложение полностью на стеке Spring


### Задание:
Преобразовать консольное приложение каталога книг в библиотеке в веб-приложение с сохранением функциональности.  
Задание выполняется на базе предыдущей работы (**Spring Data JPA** или **Spring Data Mongo DB**).


## Требования к реализации:
- Реализовать CRUD операции для сущности книги, а так же отображения авторов, жанров и комментариев. Остальные операции с сущностями - по желанию/необходимости;
- Предусмотреть:
    - страницу со списком книг,
    - списком авторов,
    - списком жанров,
    - страницу создания/редактирования книги,
    - страницу просмотра книги со списком комментариев к ней;
- Удаление сущностей можно сделать:
    - на отдельной странице подтверждения удаления,
    - на странице редактирования,
    - или по кнопке из списка;
- Для удаления **НЕ должен использоваться HTTP-метод GET**;
- Из любого места приложения должна быть возможность вернуться на главную страницу (список книг);
- Выбор авторов и жанров при редактировании должен осуществляться из списков (`<select>`), ручного ввода id быть не должно;
- Использовать **View на Thymeleaf** и классические контроллеры (`@Controller`). Использование REST/Ajax данным заданием не предусматривается;
- Протестировать все эндпойнты контроллеров для CRUD операций над книгами с помощью `@WebMvcTest` и моков сервисов;
- Локализация интерфейса данным заданием не предусматривается, она строго опциональна;
- Без фанатизма :)


# Чеклист улучшений

## Доменные сущности


## A. Равенство и хеш-код

* [ ] Для всех сущностей принять стратегию: **равны только объекты с ненулевым `id`** ( `null id` ≠ `null id` ); учесть proxy-безопасность.
* [ ] (Опционально) Для `Genre` рассмотреть равенство по **бизнес-ключу `name`** при условии уникального индекса и неизменяемости имени.

## B. Валидируемые инварианты (Bean Validation)

* [ ] `Author.fullName` — **@NotBlank**, **@Size(≤255)**.
* [ ] `Genre.name` — **@NotBlank**, **@Size(≤255)**.
* [ ] `Book.title` — **@NotBlank**, **@Size(≤255)**.
* [ ] `Book.author` — **@NotNull**.
* [ ] `Book.genres` — **не пусто** (валидация набора).
* [ ] `Comment.text` — **@NotBlank**, **@Size(≤2048)**.
* [ ] Валидации оставить на уровне домена/DTO и дублировать правилами в формах.

## C. Коллекции и инварианты

* [ ] `Book.genres` — семантика **множества** (исключить дубликаты); экспонировать read-only view.
* [ ] Управлять составом через доменные операции: `add/remove/replace` (запрет `null`, запрет дублей, контроль «не пусто»).
* [ ] При замене состава — **не менять ссылку коллекции**, использовать `clear()+addAll()` (сохранить dirty-tracking).
* [ ] (Если появятся двусторонние связи) поддерживать **консистентность обеих сторон** в доменных методах.

## D. Оптимистичная блокировка

* [ ] Добавить поле версии (`@Version`) как **целое число** минимум для `Book`; при необходимости — для `Author`, `Genre`, `Comment` (если редактируются).
* [ ] В миграциях добавить колонку `version` с `NOT NULL DEFAULT 0` в соответствующие таблицы.

## E. Единый источник времени

* [ ] Принять **приложение** как источник времени; хранить в **UTC**.
* [ ] Поля времени хранить как **`Instant`** (или жёстко зафиксировать TZ-политику для `LocalDateTime`).
* [ ] Убрать дублирование: оставить **либо** DB-default, **либо** приложенческую установку (рекомендуется второе).
* [ ] (Опционально) Ввести `updatedAt` для редактируемых сущностей.

## F. Нормализация строк

* [ ] Единая нормализация перед валидацией/сохранением: `trim`, collapse пробелов (кроме `Comment.text`), **Unicode NFC**.
* [ ] Зафиксировать регистровую политику для уникальности (например, case-insensitive для `Genre.name`) и придерживаться её в коде и БД.

## G. Уникальность и ограничения (доменные решения)

* [ ] (Рекомендуется) `Genre.name` — **уникально**; добавить **UNIQUE** индекс (в выбранной коллации/нормализации).
* [ ] (Опционально) `Author.fullName` — уникальность, если доменно допустимо.
* [ ] (Опционально) `Book` — уникальность пары `(author, title)`, если принята такая доменная политика.

## H. Прочее

* [ ] Исключить каскадное удаление «опасных» агрегатов на уровне домена (каскады оставляем на уровне связей/БД осознанно; политики удаления решить явно).
* [ ] Убедиться, что `toString` не тянет ленивые связи и не зацикливается.

___

## Репозитории и загрузка данных

* [ ] Проверить, где нужны расширенные `EntityGraph` (на страницах с комментариями может понадобиться `book.author`, `book.genres`).
* [ ] Предусмотреть пагинацию/сортировку для списков (книги/авторы/жанры/комментарии), если объёмы вырастут.
* [ ] Индексы: добавить индекс на `books(author_id)`; оценить необходимость индекса по `books_genres(genre_id)` для выборок «книги жанра X».

## Сервисы (бизнес-логика)

* [ ] Унифицировать исключения: чётко разделить «валидация входа» (ошибка пользователя) vs «не найдено» (доменная ошибка) — чтобы в UI было простое отображение.
* [ ] Инварианта «у книги должен быть ≥1 жанр»: помимо проверки в сервисе, отразить валидацией формы (и при желании — доменными правилами).
* [ ] `deleteById` без проверки существования: продумать пользовательский фидбек (сообщение «уже удалено / не найдено») либо предварительную проверку.
* [ ] Нормализация входных строк: trim/проверка пустых значений для `title/fullName/name/text` до сохранения (исключить «пустые» записи).
* [ ] Сценарий массовых удалений: переоценить `ON DELETE CASCADE` у автора (сейчас удалит книги и комментарии; для учебной задачи норм, но рискованно для реального сценария).

## Схема/DDL

* [ ] Рассмотреть уникальные ограничения: `genres.name` (часто уникально), возможно `authors.full_name` (если доменная модель это допускает).
* [ ] Уточнить длины полей (`title`, `full_name`, `name`) — зафиксировать верхние границы в DDL и валидации.
* [ ] Пересмотреть тип времени: при необходимости перейти на `Instant/OffsetDateTime` для явной TZ-семантики (актуально за пределами учебного контура).

## Веб-уровень (вперед смотря)

* [ ] Подготовить сервисные фасады, возвращающие полностью инициализированные модели для Thymeleaf (из-за `open-in-view=false`).
* [ ] Централизованный обработчик ошибок (`ControllerAdvice`) для отображения `EntityNotFound` / валидационных ошибок человекочитаемо.
* [ ] Явные сообщения валидации для форм (обязательные поля, минимум/максимум длины, выбор жанров).

## Тестирование

* [ ] Набор тестов на сервисы: сценарии «не найдено», пустые жанры, обновление, удаление (поведение и исключения).
* [ ] @WebMvcTest (позже): проверить рендер страниц, валидацию, отображение ошибок, редиректы.
